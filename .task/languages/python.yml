version: "3"

includes:
  _cfg:
    taskfile: ../config/vars.yml
    internal: true
  _platforms:
    taskfile: ../config/platforms.yml
    internal: true

tasks:
  # Installation
  install:
    desc: Install Python dependencies
    dir: packages/python
    cmds:
      - uv sync --all-extras --no-install-workspace --no-install-project

  setup:
    desc: Setup alias for install (Install Python dependencies)
    cmds:
      - task: python:install

  # Build Tasks
  build:
    desc: Build Python extension (uses {{.BUILD_PROFILE}})
    dir: packages/python
    cmds:
      - task: build:{{.BUILD_PROFILE | default "release"}}

  build:dev:
    desc: Build Python extension in debug mode
    dir: packages/python
    cmds:
      - uv run maturin develop

  build:release:
    desc: Build Python extension in release mode (optimized)
    dir: packages/python
    cmds:
      - uv run maturin build --release --strip

  build:ci:
    desc: Build Python extension in CI mode (with debug info)
    dir: packages/python
    env:
      RUSTFLAGS: '-C debuginfo=2'
    cmds:
      - uv run maturin build --release

  build:sdist:
    desc: Build Python source distribution (sdist)
    dir: packages/python
    cmds:
      - uv run maturin sdist

  build:bindings:
    desc: Build Python bindings for benchmarking
    dir: packages/python
    cmds:
      - bash ../../scripts/benchmarks/build-python-bindings.sh

  build:sdist:publish:
    desc: Build Python source distribution (sdist) for publishing to specified output directory
    cmds:
      - mkdir -p {{.DIST_DIR | default "dist"}}
      - cd packages/python && uv build --sdist --out-dir ../../{{.DIST_DIR | default "dist"}}

  # Test Tasks
  test:
    desc: Run Python tests
    dir: packages/python
    cmds:
      - uv run pytest

  test:ci:
    desc: Run Python tests in CI mode with coverage
    dir: packages/python
    cmds:
      - uv run pytest --cov --cov-report=html

  test:coverage:
    desc: Run Python tests with coverage report
    dir: packages/python
    cmds:
      - uv run pytest --cov --cov-report=html

  # Linting Tasks
  lint:
    desc: Auto-fix Python code linting (ruff check + format)
    dir: packages/python
    cmds:
      - uv run ruff check --fix
      - uv run ruff format

  lint:check:
    desc: Check Python code linting without modifications (ruff + mypy)
    dir: packages/python
    cmds:
      - uv run ruff check
      - uv run ruff format --check
      - uv run mypy

  # Formatting Tasks
  format:
    desc: Format Python code with modifications (ruff format)
    dir: packages/python
    cmds:
      - uv run ruff format

  format:check:
    desc: Check Python code formatting without modifications
    dir: packages/python
    cmds:
      - uv run ruff format --check

  # Project configuration
  pyproject:format:
    desc: Format pyproject.toml (pyproject-fmt)
    dir: packages/python
    cmds:
      - uv run pyproject-fmt pyproject.toml

  pyproject:validate:
    desc: Validate pyproject.toml (validate-pyproject)
    dir: packages/python
    cmds:
      - uv run validate-pyproject pyproject.toml

  # Cleanup
  clean:
    desc: Clean Python build artifacts
    dir: packages/python
    cmds:
      - python -c "import shutil, os, glob; [shutil.rmtree(d, ignore_errors=True) for d in glob.glob('*.egg-info')] or shutil.rmtree('build', ignore_errors=True) or shutil.rmtree('dist', ignore_errors=True)"
      - python -c "import shutil, os; [shutil.rmtree(os.path.join(r, d), ignore_errors=True) for r, dirs, _ in os.walk('.') for d in dirs if d == '__pycache__']"
      - python -c "import os, glob; [os.remove(f) for f in glob.glob('**/*.pyc', recursive=True)]"

  # Dependency Management
  update:
    desc: Update Python dependencies
    cmds:
      - echo "Updating Python dependencies..."
      - uv sync --all-packages --all-extras --upgrade --no-install-workspace --no-install-project

  # E2E Tests
  e2e:generate:
    desc: Generate Python E2E tests from fixtures
    cmds:
      - cmd: bash scripts/task/e2e-generate.sh python
        platforms: [linux, darwin]
      - cmd: echo "E2E generation not yet supported on Windows - use WSL or CI"
        platforms: [windows]

  e2e:lint:
    desc: Lint Python E2E test code
    dir: e2e/python
    cmds:
      - uv run ruff check --fix
      - uv run ruff format

  e2e:test:
    desc: Run Python E2E tests
    dir: e2e/python
    cmds:
      - uv run pytest

  e2e:verify:
    desc: Regenerate and validate Python E2E suite (generate + lint + test)
    cmds:
      - task: e2e:generate
      - task: e2e:lint
      - task: e2e:test
