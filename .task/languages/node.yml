version: "3"

includes:
  _cfg:
    taskfile: ../config/vars.yml
    internal: true
  _platforms:
    taskfile: ../config/platforms.yml
    internal: true

tasks:
  install:
    desc: Install Node/TypeScript dependencies
    dir: crates/kreuzberg-node
    cmds:
      - corepack enable
      - pnpm install -r

  setup:
    desc: Alias for install task
    cmds:
      - task: node:install

  build:
    desc: Build Node/TypeScript native bindings (uses {{.BUILD_PROFILE}})
    dir: crates/kreuzberg-node
    cmds:
      - task: build:{{.BUILD_PROFILE | default "release"}}

  build:dev:
    desc: Build Node/TypeScript native bindings in debug mode
    dir: crates/kreuzberg-node
    cmds:
      - pnpm exec napi build --platform

  build:release:
    desc: Build Node/TypeScript native bindings in release mode (optimized)
    dir: crates/kreuzberg-node
    cmds:
      - pnpm exec napi build --platform --release --strip

  build:ci:
    desc: Build Node/TypeScript native bindings in CI mode (with debug info)
    cmds:
      - cmd: |
          cd crates/kreuzberg-node
          corepack enable
          pnpm install -r
          pnpm exec napi build --platform --release
      - cmd: pnpm -r --filter="./packages/typescript/**" run build

  build:bindings:
    desc: Build Node bindings for benchmarking
    cmds:
      - bash scripts/benchmarks/build-node-bindings.sh

  test:
    desc: Run Node/TypeScript tests
    dir: crates/kreuzberg-node
    env:
      ORT_DYLIB_PATH: /opt/homebrew/lib/libonnxruntime.dylib
    cmds:
      - pnpm test

  test:ci:
    desc: Run Node/TypeScript tests in CI mode
    dir: crates/kreuzberg-node
    env:
      ORT_DYLIB_PATH: /opt/homebrew/lib/libonnxruntime.dylib
    cmds:
      - pnpm test

  lint:
    desc: Auto-fix Node/TypeScript code linting (biome + oxlint)
    dir: crates/kreuzberg-node
    cmds:
      - pnpm lint:fix
      - pnpm exec oxlint --fix typescript

  lint:check:
    desc: Check Node/TypeScript code linting without modifications (biome + typecheck)
    dir: crates/kreuzberg-node
    cmds:
      - pnpm lint
      - pnpm typecheck

  format:
    desc: Format Node/TypeScript code with modifications (biome)
    dir: crates/kreuzberg-node
    cmds:
      - pnpm format

  format:check:
    desc: Check Node/TypeScript code formatting without modifications (biome)
    dir: crates/kreuzberg-node
    cmds:
      - pnpm exec biome format typescript

  clean:
    desc: Clean Node/TypeScript build artifacts
    dir: crates/kreuzberg-node
    cmds:
      - python -c "import shutil; [shutil.rmtree(d, ignore_errors=True) for d in ['dist', 'build', 'node_modules']]"
      - python -c "import shutil, os; [shutil.rmtree(os.path.join(r, d), ignore_errors=True) for r, dirs, _ in os.walk('.') for d in dirs if d == '.turbo']"

  update:
    desc: Update Node/TypeScript dependencies
    dir: crates/kreuzberg-node
    cmds:
      - echo "Updating Node/TypeScript dependencies..."
      - corepack up
      - pnpm up --latest

  e2e:generate:
    desc: Generate and format TypeScript E2E tests
    cmds:
      - cmd: bash scripts/task/e2e-typescript-generate.sh
        platforms: [linux, darwin]
      - cmd: echo "E2E generation not yet supported on Windows - use WSL or CI"
        platforms: [windows]
      - task: e2e:lint

  e2e:lint:
    desc: Lint TypeScript E2E code
    dir: e2e/typescript
    cmds:
      - pnpm exec biome check .
      - pnpm exec oxlint --fix typescript

  e2e:test:
    desc: Run TypeScript E2E tests
    dir: e2e/typescript
    cmds:
      - pnpm test

  e2e:verify:
    desc: Regenerate and validate TypeScript E2E suite (generate + lint + test)
    cmds:
      - task: e2e:generate
      - task: e2e:lint
      - task: e2e:test
