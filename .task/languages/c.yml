version: "3"

includes:
  _cfg:
    taskfile: ../config/vars.yml
    internal: true
  _platforms:
    taskfile: ../config/platforms.yml
    internal: true

vars:
  FFI_CRATE_DIR: "crates/kreuzberg-ffi"
  FFI_TEST_DIR: "crates/kreuzberg-ffi/tests/c"
  E2E_DIR: "e2e/c"
  LIB_DIR: "target/debug"
  LIB_DIR_RELEASE: "target/release"

tasks:
  install:
    desc: Verify C build tools are available (cc, make, clang-format, cppcheck)
    cmds:
      - cmd: >-
          bash -c 'command -v cc >/dev/null && echo "cc found" || echo "WARNING: cc not found"'
        platforms: [linux, darwin]
      - cmd: >-
          bash -c 'command -v make >/dev/null && echo "make found" || echo "WARNING: make not found"'
        platforms: [linux, darwin]
      - cmd: echo "C toolchain check - ensure MSVC or MinGW is available"
        platforms: [windows]

  setup:
    desc: Setup C build environment (alias for install)
    cmds:
      - task: c:install

  build:
    desc: Build kreuzberg-ffi C library (debug)
    cmds:
      - cargo build -p kreuzberg-ffi

  build:dev:
    desc: Build kreuzberg-ffi C library in debug mode
    cmds:
      - cargo build -p kreuzberg-ffi

  build:release:
    desc: Build kreuzberg-ffi C library in release mode
    cmds:
      - cargo build -p kreuzberg-ffi --release

  build:ci:
    desc: Build kreuzberg-ffi C library in CI mode
    cmds:
      - cargo build -p kreuzberg-ffi

  build:bindings:
    desc: Build C FFI bindings for benchmarking
    cmds:
      - cargo build -p kreuzberg-ffi --release

  test:
    desc: Run C FFI unit tests
    cmds:
      - cmd: bash -c 'make -C {{.FFI_TEST_DIR}} LIBDIR="$(pwd)/{{.LIB_DIR}}" clean all test'
        platforms: [linux, darwin]
      - cmd: echo "C FFI tests not yet supported on Windows"
        platforms: [windows]

  test:ci:
    desc: Run C FFI unit tests in CI mode
    env:
      CI: "true"
    cmds:
      - cmd: bash -c 'make -C {{.FFI_TEST_DIR}} LIBDIR="$(pwd)/{{.LIB_DIR}}" clean all test'
        platforms: [linux, darwin]
      - cmd: echo "C FFI tests not yet supported on Windows"
        platforms: [windows]

  test:verbose:
    desc: Run C FFI unit tests with verbose output
    cmds:
      - cmd: >-
          bash -c 'make -C {{.FFI_TEST_DIR}} LIBDIR="$(pwd)/{{.LIB_DIR}}" clean all &&
          for t in {{.FFI_TEST_DIR}}/test_*; do [ -x "$t" ] || continue;
          echo "=== $(basename $t) ==="; "$t" && echo "PASS" || echo "FAIL"; done'
        platforms: [linux, darwin]
      - cmd: echo "C FFI tests not yet supported on Windows"
        platforms: [windows]

  lint:
    desc: Lint C code with cppcheck and clang-format (auto-fix)
    cmds:
      - cmd: >-
          bash -c 'find {{.FFI_TEST_DIR}} {{.E2E_DIR}} -name "*.c" -o -name "*.h" |
          xargs clang-format -i 2>/dev/null || echo "clang-format not available"'
        platforms: [linux, darwin]
      - cmd: >-
          bash -c 'cppcheck --enable=warning,style --error-exitcode=0
          {{.FFI_TEST_DIR}}/*.c {{.E2E_DIR}}/*.c 2>/dev/null || echo "cppcheck not available"'
        platforms: [linux, darwin]

  lint:check:
    desc: Lint C code in check-only mode (no fixes)
    cmds:
      - cmd: >-
          bash -c 'find {{.FFI_TEST_DIR}} {{.E2E_DIR}} -name "*.c" -o -name "*.h" |
          xargs clang-format --dry-run --Werror 2>/dev/null || echo "clang-format not available"'
        platforms: [linux, darwin]
      - cmd: >-
          bash -c 'cppcheck --enable=warning,style --error-exitcode=1
          {{.FFI_TEST_DIR}}/*.c {{.E2E_DIR}}/*.c 2>/dev/null || echo "cppcheck not available"'
        platforms: [linux, darwin]

  format:
    desc: Format C code with clang-format
    cmds:
      - cmd: >-
          bash -c 'find {{.FFI_TEST_DIR}} {{.E2E_DIR}} -name "*.c" -o -name "*.h" |
          xargs clang-format -i'
        platforms: [linux, darwin]

  format:check:
    desc: Check C code formatting without modifications
    cmds:
      - cmd: >-
          bash -c 'find {{.FFI_TEST_DIR}} {{.E2E_DIR}} -name "*.c" -o -name "*.h" |
          xargs clang-format --dry-run --Werror'
        platforms: [linux, darwin]

  clean:
    desc: Clean C build artifacts
    cmds:
      - cmd: make -C {{.FFI_TEST_DIR}} clean 2>/dev/null || true
        platforms: [linux, darwin]
      - cmd: make -C {{.E2E_DIR}} clean 2>/dev/null || true
        platforms: [linux, darwin]

  update:
    desc: Update C dependencies (no-op, C deps are managed via Rust FFI crate)
    cmds:
      - echo "C dependencies managed via Rust FFI crate (cargo update -p kreuzberg-ffi)"

  e2e:generate:
    desc: Generate C E2E tests from fixtures
    cmds:
      - cmd: bash scripts/task/e2e-generate.sh c
        platforms: [linux, darwin]
      - cmd: echo "E2E generation not yet supported on Windows - use WSL or CI"
        platforms: [windows]

  e2e:lint:
    desc: Lint C E2E code
    cmds:
      - cmd: >-
          bash -c 'find {{.E2E_DIR}} -name "*.c" -o -name "*.h" |
          xargs clang-format --dry-run --Werror 2>/dev/null || echo "clang-format not available"'
        platforms: [linux, darwin]

  e2e:test:
    desc: Run C E2E tests
    cmds:
      - cmd: bash -c 'make -C {{.E2E_DIR}} LIBDIR="$(pwd)/{{.LIB_DIR}}" clean all test'
        platforms: [linux, darwin]
      - cmd: echo "C E2E tests not yet supported on Windows"
        platforms: [windows]

  e2e:verify:
    desc: Full C E2E pipeline (generate + lint + test)
    cmds:
      - task: e2e:generate
      - task: e2e:lint
      - task: e2e:test
