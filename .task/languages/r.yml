version: "3"

includes:
  _cfg:
    taskfile: ../config/vars.yml
    internal: true
  _platforms:
    taskfile: ../config/platforms.yml
    internal: true

tasks:
  install:
    desc: Install R dependencies
    dir: packages/r
    cmds:
      - Rscript -e "if (!require('testthat', quietly = TRUE)) install.packages('testthat', repos = 'https://cran.r-project.org')"
      - Rscript -e "if (!require('jsonlite', quietly = TRUE)) install.packages('jsonlite', repos = 'https://cran.r-project.org')"
      - Rscript -e "if (!require('withr', quietly = TRUE)) install.packages('withr', repos = 'https://cran.r-project.org')"

  setup:
    desc: Alias for install
    cmds:
      - task: r:install

  build:
    desc: Build R native extension
    dir: packages/r
    cmds:
      - R CMD INSTALL --no-multiarch --with-keep.source .

  build:dev:
    desc: Build R native extension in debug mode
    dir: packages/r
    cmds:
      - R CMD INSTALL --no-multiarch --with-keep.source .

  build:release:
    desc: Build R native extension in release mode (optimized)
    dir: packages/r
    cmds:
      - R CMD INSTALL --no-multiarch --with-keep.source .

  build:ci:
    desc: Build R package in CI mode
    dir: packages/r
    cmds:
      - R CMD build .
      - R CMD INSTALL --no-multiarch --with-keep.source .

  test:
    desc: Run R tests
    dir: packages/r
    cmds:
      - Rscript -e "testthat::test_local()"

  test:ci:
    desc: Run R tests in CI mode
    dir: packages/r
    cmds:
      - Rscript -e "testthat::test_local(reporter = 'summary')"

  test:verbose:
    desc: Run R tests with detailed output
    dir: packages/r
    cmds:
      - Rscript -e "testthat::test_local(reporter = 'progress')"

  lint:
    desc: Auto-fix R code linting (lintr + styler)
    dir: packages/r
    cmds:
      - Rscript -e "styler::style_dir('R')"
      - Rscript -e "lintr::lint_dir('R')"

  lint:check:
    desc: Check R code linting without modifications
    dir: packages/r
    cmds:
      - Rscript -e "results <- lintr::lint_dir('R'); if (length(results) > 0) { print(results); quit(status = 1) }"

  format:
    desc: Format R code with styler
    dir: packages/r
    cmds:
      - Rscript -e "styler::style_dir('R')"

  format:check:
    desc: Check R code formatting without modifications
    dir: packages/r
    cmds:
      - Rscript -e "style_changes <- styler::style_dir('R', dry = 'on'); if (any(style_changes[['changed']] == TRUE)) quit(status = 1)"

  console:
    desc: Open R console with kreuzberg loaded
    dir: packages/r
    cmds:
      - R -e "library(kreuzberg)"

  clean:
    desc: Clean R build artifacts
    dir: packages/r
    cmds:
      - python -c "import shutil, os; [shutil.rmtree(d, ignore_errors=True) for d in ['src/rust/target', 'src/Makevars']]"
      - python -c "import glob, os; [os.remove(f) for f in glob.glob('src/*.o') + glob.glob('src/*.so') + glob.glob('src/*.dll')]"

  update:
    desc: Update R dependencies
    dir: packages/r
    cmds:
      - Rscript -e "update.packages(repos = 'https://cran.r-project.org', ask = FALSE)"

  e2e:generate:
    desc: Generate R E2E tests from fixtures
    cmds:
      - cmd: bash scripts/task/e2e-generate.sh r
        platforms: [linux, darwin]
      - cmd: echo "E2E generation not yet supported on Windows"
        platforms: [windows]

  e2e:test:
    desc: Run R E2E tests
    dir: e2e/r
    cmds:
      - Rscript -e "testthat::test_local()"

  e2e:lint:
    desc: Lint R E2E code
    dir: e2e/r
    cmds:
      - Rscript -e "lintr::lint_dir('tests')"

  e2e:verify:
    desc: Regenerate and validate R E2E suite (generate + lint + test)
    cmds:
      - task: e2e:generate
      - task: e2e:lint
      - task: e2e:test
