version: '3'

tasks:
  install:
    desc: Install Elixir dependencies
    dir: packages/elixir
    cmds:
      - mix deps.get

  setup:
    desc: Setup Elixir environment
    cmds:
      - task: install

  build:
    desc: Build Elixir package
    dir: packages/elixir
    cmds:
      - mix compile

  build:dev:
    desc: Build Elixir package (dev mode)
    dir: packages/elixir
    cmds:
      - mix compile

  build:release:
    desc: Build Elixir package (release mode)
    dir: packages/elixir
    env:
      MIX_ENV: prod
    cmds:
      - mix compile

  build:ci:
    desc: Build Elixir package (CI mode)
    dir: packages/elixir
    env:
      MIX_ENV: test
    cmds:
      - mix compile --warnings-as-errors

  test:
    desc: Run Elixir tests
    dir: packages/elixir
    cmds:
      - mix test

  test:ci:
    desc: Run Elixir tests (CI mode)
    dir: packages/elixir
    cmds:
      - mix test --warnings-as-errors

  test:app:
    desc: Run Elixir test app
    dir: tests/test_apps/elixir
    cmds:
      - mix deps.get
      - mix test

  test:app:ci:
    desc: Run Elixir test app (CI mode)
    dir: tests/test_apps/elixir
    cmds:
      - mix deps.get
      - mix test --warnings-as-errors --exclude ocr

  lint:
    desc: Lint all Elixir code with auto-fix (format + credo)
    cmds:
      - cmd: bash scripts/task/elixir-lint.sh fix
        platforms: [linux, darwin]

  lint:check:
    desc: Check all Elixir code linting without modifications
    cmds:
      - cmd: bash scripts/task/elixir-lint.sh check
        platforms: [linux, darwin]

  format:
    desc: Format Elixir code
    dir: packages/elixir
    cmds:
      - mix format

  format:check:
    desc: Check Elixir code formatting
    dir: packages/elixir
    cmds:
      - mix format --check-formatted

  build:bindings:
    desc: Build Elixir bindings for benchmarking
    cmds:
      - bash scripts/benchmarks/build-elixir-bindings.sh

  clean:
    desc: Clean Elixir build artifacts
    dir: packages/elixir
    cmds:
      - mix clean
      - rm -rf _build
      - rm -rf deps

  update:
    desc: Update Elixir dependencies to latest versions (including major versions)
    dir: packages/elixir
    cmds:
      - echo "Updating Elixir dependencies to latest versions..."
      - cmd: echo "Note - Elixir requires manual mix.exs edits for major version updates"
      - mix hex.outdated
      - mix deps.update --all
      - echo "Checking remaining outdated dependencies..."
      - mix hex.outdated || true

  docs:
    desc: Generate Elixir documentation
    dir: packages/elixir
    cmds:
      - mix docs

  e2e:generate:
    desc: Generate and format Elixir E2E tests from fixtures
    cmds:
      - cmd: bash scripts/task/e2e-generate.sh elixir
        platforms: [linux, darwin]
      - cmd: echo "E2E generation not yet supported on Windows - use WSL or CI"
        platforms: [windows]
      - task: e2e:format

  e2e:format:
    desc: Format Elixir E2E code
    dir: e2e/elixir
    cmds:
      - mix deps.get --quiet
      - mix format

  e2e:test:
    desc: Run generated Elixir E2E tests
    dir: e2e/elixir
    cmds:
      - mix deps.get
      - mix test

  e2e:lint:
    desc: Lint generated Elixir E2E tests
    dir: e2e/elixir
    cmds:
      - mix format --check-formatted
