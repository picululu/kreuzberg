name: CI C FFI

on:
  push:
    branches: [main]
    paths:
      - '.github/actions/**'
      - '.github/workflows/ci-c-ffi.yaml'
      - '.cargo/config.toml'
      - 'rust-toolchain.toml'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'crates/kreuzberg/**'
      - 'crates/kreuzberg-ffi/**'
      - 'crates/kreuzberg-tesseract/**'
  pull_request:
    branches: [main]
    paths:
      - '.github/actions/**'
      - '.github/workflows/ci-c-ffi.yaml'
      - '.cargo/config.toml'
      - 'rust-toolchain.toml'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'crates/kreuzberg/**'
      - 'crates/kreuzberg-ffi/**'
      - 'crates/kreuzberg-tesseract/**'
  workflow_dispatch:

concurrency:
  group: ci-c-ffi-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  RUST_BACKTRACE: short

jobs:
  c-ffi-tests:
    name: C FFI Tests (${{ matrix.os }})
    if: github.repository == 'kreuzberg-dev/kreuzberg' && github.actor != 'dependabot[bot]'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
          - os: macos-latest
    steps:
      - uses: actions/checkout@v4
        id: checkout

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: c-ffi-${{ matrix.os }}
          use-sccache: 'true'

      - name: Build kreuzberg-ffi
        shell: bash
        run: cargo build -p kreuzberg-ffi

      - name: Compile C tests
        shell: bash
        run: make -C crates/kreuzberg-ffi/tests/c LIBDIR="$(pwd)/target/debug" clean all

      - name: Run C tests
        shell: bash
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/target/debug
          DYLD_LIBRARY_PATH: ${{ github.workspace }}/target/debug
        run: |
          FAILED=0
          for test in crates/kreuzberg-ffi/tests/c/test_*; do
            [ -x "$test" ] || continue
            name=$(basename "$test")
            if "$test"; then
              echo "PASS: $name"
            else
              echo "FAIL: $name"
              FAILED=1
            fi
          done
          [ "$FAILED" -eq 0 ] || exit 1

      - name: Verify pkg-config output
        shell: bash
        run: |
          PC_DIR="$(pwd)/target/debug/build"
          PC_FILE=$(find "$PC_DIR" -name 'kreuzberg.pc' -path '*/kreuzberg-ffi-*/out/*' 2>/dev/null | head -1)
          if [ -z "$PC_FILE" ]; then
            echo "Warning: kreuzberg.pc not found in build output (expected in cargo build dir)"
            echo "Checking known output locations..."
            find "$PC_DIR" -name '*.pc' 2>/dev/null || echo "No .pc files found"
          else
            echo "Found pkg-config file: $PC_FILE"
            cat "$PC_FILE"
          fi

      - name: Verify header version constants
        shell: bash
        run: |
          HEADER="crates/kreuzberg-ffi/kreuzberg.h"
          echo "Checking version constants in $HEADER..."
          grep 'KREUZBERG_VERSION_MAJOR' "$HEADER"
          grep 'KREUZBERG_VERSION_MINOR' "$HEADER"
          grep 'KREUZBERG_VERSION_PATCH' "$HEADER"
          grep 'KREUZBERG_VERSION ' "$HEADER"
          echo "Version constants verified."

      - name: Verify CMake config files exist
        shell: bash
        run: |
          test -f crates/kreuzberg-ffi/cmake/kreuzberg-ffi-config.cmake
          test -f crates/kreuzberg-ffi/cmake/kreuzberg-ffi-config-version.cmake
          echo "CMake config files verified."

      - name: Cleanup Rust cache
        if: always() && steps.checkout.outcome == 'success'
        uses: ./.github/actions/cleanup-rust-cache

  c-ffi-tests-windows:
    name: C FFI Tests (windows-latest)
    if: github.repository == 'kreuzberg-dev/kreuzberg' && github.actor != 'dependabot[bot]'
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        id: checkout

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: c-ffi-windows
          use-sccache: 'true'
          disable-cache: 'true'

      - name: Build kreuzberg-ffi
        shell: bash
        run: cargo build -p kreuzberg-ffi

      - name: Verify header generated
        shell: bash
        run: |
          test -f crates/kreuzberg-ffi/kreuzberg.h
          grep 'KREUZBERG_VERSION_MAJOR' crates/kreuzberg-ffi/kreuzberg.h
          echo "Header verified on Windows."
