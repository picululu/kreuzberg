// Auto-generated tests for email fixtures.

import { existsSync, readFileSync } from "node:fs";
import type { ExtractionResult } from "@kreuzberg/node";
import { extractFileSync } from "@kreuzberg/node";
import { describe, it } from "vitest";
import { assertions, buildConfig, resolveDocument, shouldSkipFixture } from "./helpers.js";

const TEST_TIMEOUT_MS = 60_000;

describe("email fixtures", () => {
	it(
		"email_eml_html_body",
		() => {
			const documentPath = resolveDocument("email/html_only.eml");
			if (!existsSync(documentPath)) {
				console.warn("Skipping email_eml_html_body: missing document at", documentPath);
				return;
			}
			const config = buildConfig(undefined);
			let result: ExtractionResult | null = null;
			try {
				result = extractFileSync(documentPath, null, config);
			} catch (error) {
				if (shouldSkipFixture(error, "email_eml_html_body", [], undefined)) {
					return;
				}
				throw error;
			}
			if (result === null) {
				return;
			}
			assertions.assertExpectedMime(result, ["message/rfc822"]);
			assertions.assertMinContentLength(result, 10);
		},
		TEST_TIMEOUT_MS,
	);

	it(
		"email_eml_multipart",
		() => {
			const documentPath = resolveDocument("email/html_email_multipart.eml");
			if (!existsSync(documentPath)) {
				console.warn("Skipping email_eml_multipart: missing document at", documentPath);
				return;
			}
			const config = buildConfig(undefined);
			let result: ExtractionResult | null = null;
			try {
				result = extractFileSync(documentPath, null, config);
			} catch (error) {
				if (shouldSkipFixture(error, "email_eml_multipart", [], undefined)) {
					return;
				}
				throw error;
			}
			if (result === null) {
				return;
			}
			assertions.assertExpectedMime(result, ["message/rfc822"]);
			assertions.assertMinContentLength(result, 10);
		},
		TEST_TIMEOUT_MS,
	);

	it(
		"email_eml_utf16",
		() => {
			const documentPath = resolveDocument("vendored/unstructured/eml/fake-email-utf-16.eml");
			if (!existsSync(documentPath)) {
				console.warn("Skipping email_eml_utf16: missing document at", documentPath);
				return;
			}
			const config = buildConfig(undefined);
			let result: ExtractionResult | null = null;
			try {
				result = extractFileSync(documentPath, null, config);
			} catch (error) {
				if (shouldSkipFixture(error, "email_eml_utf16", [], undefined)) {
					return;
				}
				throw error;
			}
			if (result === null) {
				return;
			}
			assertions.assertExpectedMime(result, ["message/rfc822"]);
			assertions.assertMinContentLength(result, 50);
			assertions.assertContentContainsAny(result, ["Test Email", "Roses are red"]);
		},
		TEST_TIMEOUT_MS,
	);

	it(
		"email_msg_basic",
		() => {
			const documentPath = resolveDocument("email/fake_email.msg");
			if (!existsSync(documentPath)) {
				console.warn("Skipping email_msg_basic: missing document at", documentPath);
				return;
			}
			const config = buildConfig(undefined);
			let result: ExtractionResult | null = null;
			try {
				result = extractFileSync(documentPath, null, config);
			} catch (error) {
				if (shouldSkipFixture(error, "email_msg_basic", [], undefined)) {
					return;
				}
				throw error;
			}
			if (result === null) {
				return;
			}
			assertions.assertExpectedMime(result, ["application/vnd.ms-outlook"]);
			assertions.assertMinContentLength(result, 10);
		},
		TEST_TIMEOUT_MS,
	);

	it(
		"email_sample_eml",
		() => {
			const documentPath = resolveDocument("email/sample_email.eml");
			if (!existsSync(documentPath)) {
				console.warn("Skipping email_sample_eml: missing document at", documentPath);
				return;
			}
			const config = buildConfig(undefined);
			let result: ExtractionResult | null = null;
			try {
				result = extractFileSync(documentPath, null, config);
			} catch (error) {
				if (shouldSkipFixture(error, "email_sample_eml", [], undefined)) {
					return;
				}
				throw error;
			}
			if (result === null) {
				return;
			}
			assertions.assertExpectedMime(result, ["message/rfc822"]);
			assertions.assertMinContentLength(result, 20);
		},
		TEST_TIMEOUT_MS,
	);
});
