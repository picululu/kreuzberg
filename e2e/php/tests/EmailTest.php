<?php

declare(strict_types=1);

// Auto-generated tests for email fixtures.

namespace E2EPhp\Tests;

use E2EPhp\Helpers;
use Kreuzberg\Kreuzberg;
use PHPUnit\Framework\TestCase;

class EmailTest extends TestCase
{
    /**
     * EML with HTML body content.
     */
    public function test_email_eml_html_body(): void
    {
        $documentPath = Helpers::resolveDocument('email/html_only.eml');
        if (!file_exists($documentPath)) {
            $this->markTestSkipped('Skipping email_eml_html_body: missing document at ' . $documentPath);
        }

        $config = Helpers::buildConfig(null);

        $kreuzberg = new Kreuzberg($config);
        $result = $kreuzberg->extractFile($documentPath);

        Helpers::assertExpectedMime($result, ['message/rfc822']);
        Helpers::assertMinContentLength($result, 10);
    }

    /**
     * EML with multipart MIME content.
     */
    public function test_email_eml_multipart(): void
    {
        $documentPath = Helpers::resolveDocument('email/html_email_multipart.eml');
        if (!file_exists($documentPath)) {
            $this->markTestSkipped('Skipping email_eml_multipart: missing document at ' . $documentPath);
        }

        $config = Helpers::buildConfig(null);

        $kreuzberg = new Kreuzberg($config);
        $result = $kreuzberg->extractFile($documentPath);

        Helpers::assertExpectedMime($result, ['message/rfc822']);
        Helpers::assertMinContentLength($result, 10);
    }

    /**
     * UTF-16 encoded EML file with BOM.
     */
    public function test_email_eml_utf16(): void
    {
        $documentPath = Helpers::resolveDocument('vendored/unstructured/eml/fake-email-utf-16.eml');
        if (!file_exists($documentPath)) {
            $this->markTestSkipped('Skipping email_eml_utf16: missing document at ' . $documentPath);
        }

        $config = Helpers::buildConfig(null);

        $kreuzberg = new Kreuzberg($config);
        $result = $kreuzberg->extractFile($documentPath);

        Helpers::assertExpectedMime($result, ['message/rfc822']);
        Helpers::assertMinContentLength($result, 50);
        Helpers::assertContentContainsAny($result, ['Test Email', 'Roses are red']);
    }

    /**
     * Outlook MSG file extraction.
     */
    public function test_email_msg_basic(): void
    {
        $documentPath = Helpers::resolveDocument('email/fake_email.msg');
        if (!file_exists($documentPath)) {
            $this->markTestSkipped('Skipping email_msg_basic: missing document at ' . $documentPath);
        }

        $config = Helpers::buildConfig(null);

        $kreuzberg = new Kreuzberg($config);
        $result = $kreuzberg->extractFile($documentPath);

        Helpers::assertExpectedMime($result, ['application/vnd.ms-outlook']);
        Helpers::assertMinContentLength($result, 10);
    }

    /**
     * Sample EML email file to verify email parsing.
     */
    public function test_email_sample_eml(): void
    {
        $documentPath = Helpers::resolveDocument('email/sample_email.eml');
        if (!file_exists($documentPath)) {
            $this->markTestSkipped('Skipping email_sample_eml: missing document at ' . $documentPath);
        }

        $config = Helpers::buildConfig(null);

        $kreuzberg = new Kreuzberg($config);
        $result = $kreuzberg->extractFile($documentPath);

        Helpers::assertExpectedMime($result, ['message/rfc822']);
        Helpers::assertMinContentLength($result, 20);
    }

}
