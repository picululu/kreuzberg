// Auto-generated tests for email fixtures.
// Designed for Cloudflare Workers with Vitest + Miniflare

import type { ExtractionResult } from "@kreuzberg/wasm";
import { extractBytes } from "@kreuzberg/wasm";
import { describe, expect, it } from "vitest";
import { assertions, buildConfig, getFixture, shouldSkipFixture } from "./helpers.js";

describe("email", () => {
	it("email_eml_html_body", async () => {
		const documentBytes = getFixture("email/html_only.eml");
		if (documentBytes === null) {
			console.warn("[SKIP] Test skipped: fixture not available in Cloudflare Workers environment");
			return;
		}

		const config = buildConfig(undefined);
		let result: ExtractionResult | null = null;
		try {
			result = await extractBytes(documentBytes, "message/rfc822", config);
		} catch (error) {
			if (shouldSkipFixture(error, "email_eml_html_body", [], undefined)) {
				return;
			}
			throw error;
		}
		if (result === null) {
			return;
		}
		assertions.assertExpectedMime(result, ["message/rfc822"]);
		assertions.assertMinContentLength(result, 10);
	});

	it("email_eml_multipart", async () => {
		const documentBytes = getFixture("email/html_email_multipart.eml");
		if (documentBytes === null) {
			console.warn("[SKIP] Test skipped: fixture not available in Cloudflare Workers environment");
			return;
		}

		const config = buildConfig(undefined);
		let result: ExtractionResult | null = null;
		try {
			result = await extractBytes(documentBytes, "message/rfc822", config);
		} catch (error) {
			if (shouldSkipFixture(error, "email_eml_multipart", [], undefined)) {
				return;
			}
			throw error;
		}
		if (result === null) {
			return;
		}
		assertions.assertExpectedMime(result, ["message/rfc822"]);
		assertions.assertMinContentLength(result, 10);
	});

	it("email_eml_utf16", async () => {
		const documentBytes = getFixture("vendored/unstructured/eml/fake-email-utf-16.eml");
		if (documentBytes === null) {
			console.warn("[SKIP] Test skipped: fixture not available in Cloudflare Workers environment");
			return;
		}

		const config = buildConfig(undefined);
		let result: ExtractionResult | null = null;
		try {
			result = await extractBytes(documentBytes, "message/rfc822", config);
		} catch (error) {
			if (shouldSkipFixture(error, "email_eml_utf16", [], undefined)) {
				return;
			}
			throw error;
		}
		if (result === null) {
			return;
		}
		assertions.assertExpectedMime(result, ["message/rfc822"]);
		assertions.assertMinContentLength(result, 50);
		assertions.assertContentContainsAny(result, ["Test Email", "Roses are red"]);
	});

	it("email_msg_basic", async () => {
		const documentBytes = getFixture("email/fake_email.msg");
		if (documentBytes === null) {
			console.warn("[SKIP] Test skipped: fixture not available in Cloudflare Workers environment");
			return;
		}

		const config = buildConfig(undefined);
		let result: ExtractionResult | null = null;
		try {
			result = await extractBytes(documentBytes, "application/vnd.ms-outlook", config);
		} catch (error) {
			if (shouldSkipFixture(error, "email_msg_basic", [], undefined)) {
				return;
			}
			throw error;
		}
		if (result === null) {
			return;
		}
		assertions.assertExpectedMime(result, ["application/vnd.ms-outlook"]);
		assertions.assertMinContentLength(result, 10);
	});

	it("email_sample_eml", async () => {
		const documentBytes = getFixture("email/sample_email.eml");
		if (documentBytes === null) {
			console.warn("[SKIP] Test skipped: fixture not available in Cloudflare Workers environment");
			return;
		}

		const config = buildConfig(undefined);
		let result: ExtractionResult | null = null;
		try {
			result = await extractBytes(documentBytes, "message/rfc822", config);
		} catch (error) {
			if (shouldSkipFixture(error, "email_sample_eml", [], undefined)) {
				return;
			}
			throw error;
		}
		if (result === null) {
			return;
		}
		assertions.assertExpectedMime(result, ["message/rfc822"]);
		assertions.assertMinContentLength(result, 20);
	});
});
